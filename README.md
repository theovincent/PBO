# Projected Bellman Operator (PBO)

## User installation
### Without Docker, with Python 3.8 or 3.9 installed
In the folder where the code is, create a Python virtual environment, activate it and install the package and its dependencies in editable mode:
```bash
python3 -m venv env
source env/bin/activate
pip install -e .[cpu]
```

### With Docker
In the folder where the code is, build the image and run the container in iterative mode:
```bash
docker build -t pbo_image .
docker run -it --mount type=bind,src=`pwd`/figure_specific,dst=/workspace/figure_specific pbo_image bash
```

## Run the experiments
For an `environment` and an `algorithm`, a jupyter notebook running the associated the experience can be found at _figure_specific/[environment]/[algorithm].ipynb_.

For example, the jupyter notebook _figure_specific/chain_walk/PBO_linear.ipynb_ trains a linear PBO on the Chain-Walk environment.

To generate the plots with $N$ seeds with $K$ Bellman iterations, you first need to generate the data by running `./figure_specific/[environment]/run_seeds.sh -n_seeds N -n_bellman_iteration K`
and then run the jupyter notebook _figure_specific/[environment]/plots.ipynb_.

### Replicate figures
Figure 4a with one seed, run
```Bash
./figure_specific/chain_walk/run_seeds.sh --n_seeds 1 --n_bellman_iterations 5
jupyter nbconvert --to notebook --inplace --execute figure_specific/chain_walk/plots.ipynb
```
You will find Figure 4a at _figure_specific/chain_walk/figures/distance_to_optimal_V_5.pdf_. The code should take around 5 minutes to run.

Figure 4b with one seed, run
```Bash
./figure_specific/lqr/run_seeds.sh --n_seeds 1 --n_bellman_iterations 2
jupyter nbconvert --to notebook --inplace --execute figure_specific/lqr/plots.ipynb
```
You will find Figure 4b at _figure_specific/lqr/figures/distance_to_optimal_Pi_2.pdf_. The code should take around 2 minutes to run.

Figure 5a with one seed, run
```Bash
./figure_specific/car_on_hill/run_seeds.sh --n_seeds 1 --n_bellman_iterations 9
jupyter nbconvert --to notebook --inplace --execute figure_specific/car_on_hill/samples.ipynb
jupyter nbconvert --to notebook --inplace --execute figure_specific/car_on_hill/plots.ipynb
```
You will find Figure 5a at _figure_specific/car_on_hill/figures/distance_to_optimal_V_9.pdf_. The code should take around 30 minutes to run.

Figure 5b with one seed, run
```Bash
./figure_specific/bicycle/run_seeds.sh --n_seeds 1 --n_bellman_iterations 8
jupyter nbconvert --to notebook --inplace --execute figure_specific/bicycle/plots.ipynb
```
You will find Figure 5a at _figure_specific/bicycle/figures/seconds_8.pdf_. The code should take around 45 minutes to run.

If any problem is encountered, make sure your files match the [file organization](#file-organization) and that the parameters _figure_specific/[environment]/plots.ipynb_ are matching the data that has been computed so far.

## Run the tests
Run all tests with
```Bash
pytest
```
The code should take around 1 minutes to run.

## File organization
```
ğŸ“¦PBO
 â”£ ğŸ“‚env  # environment files
 â”£ ğŸ“‚figure_specific  # files to run the experiments
 â”ƒ â”£ ğŸ“‚bicycle
 â”ƒ â”ƒ â”£ ğŸ“‚figures
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚data
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚FQI
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy  # data generated by running the experiments
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚PBO_linear
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚PBO_linear_max_linear
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚PBO_optimal
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“‚optimal
 â”ƒ â”ƒ â”ƒ â”ƒ   â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...pdf  # plots of the experiments generated from plots.ipynb
 â”ƒ â”ƒ â”£ ğŸ“œFQI.ipynb
 â”ƒ â”ƒ â”£ ğŸ“œPBO_linear_max_linear.ipynb
 â”ƒ â”ƒ â”£ ğŸ“œPBO_linear.ipynb
 â”ƒ â”ƒ â”£ ğŸ“œparameters.json
 â”ƒ â”ƒ â”£ ğŸ“œplots.ipynb
 â”ƒ â”ƒ â”— ğŸ“œrun_seeds.sh
 â”ƒ â”£ ğŸ“‚car_on_hill
 â”ƒ â”ƒ â”£ ğŸ“‚figures
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚data
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚FQI
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚PBO_linear
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚PBO_linear_max_linear
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚PBO_optimal
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“‚optimal
 â”ƒ â”ƒ â”ƒ â”ƒ   â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...pdf
 â”ƒ â”ƒ â”£ ğŸ“œFQI.ipynb
 â”ƒ â”ƒ â”£ ğŸ“œPBO_linear_max_linear.ipynb
 â”ƒ â”ƒ â”£ ğŸ“œPBO_linear.ipynb
 â”ƒ â”ƒ â”£ ğŸ“œoptimal.py
 â”ƒ â”ƒ â”£ ğŸ“œparameters.json
 â”ƒ â”ƒ â”£ ğŸ“œplots.ipynb
 â”ƒ â”ƒ â”— ğŸ“œrun_seeds.sh
 â”ƒ â”£ ğŸ“‚chain_walk
 â”ƒ â”ƒ â”£ ğŸ“‚figures
 â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚data
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚FQI
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚LSPI
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚PBO_linear
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚PBO_max_linear
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ğŸ“‚PBO_optimal
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“‚optimal
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...pdf
 â”ƒ â”ƒ â”£ ğŸ“œFQI.ipynb
 â”ƒ â”ƒ â”£ ğŸ“œLSPI.ipynb
 â”ƒ â”ƒ â”£ ğŸ“œPBO_linear.ipynb
 â”ƒ â”ƒ â”£ ğŸ“œPBO_max_linear.ipynb
 â”ƒ â”ƒ â”£ ğŸ“œPBO_optimal.ipynb
 â”ƒ â”ƒ â”£ ğŸ“œoptimal.ipynb
 â”ƒ â”ƒ â”£ ğŸ“œparameters.json
 â”ƒ â”ƒ â”£ ğŸ“œplots.ipynb
 â”ƒ â”ƒ â”— ğŸ“œrun_seeds.sh
 â”ƒ â”— ğŸ“‚lqr
 â”ƒ   â”£ ğŸ“‚figures
 â”ƒ   â”ƒ â”£ ğŸ“‚data
 â”ƒ   â”ƒ â”ƒ â”£ ğŸ“‚FQI
 â”ƒ   â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ   â”ƒ â”ƒ â”£ ğŸ“‚LSPI
 â”ƒ   â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ   â”ƒ â”ƒ â”£ ğŸ“‚PBO_custom_linear
 â”ƒ   â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ   â”ƒ â”ƒ â”£ ğŸ“‚PBO_linear
 â”ƒ   â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ   â”ƒ â”ƒ â”£ ğŸ“‚PBO_optimal
 â”ƒ   â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ   â”ƒ â”ƒ â”— ğŸ“‚optimal
 â”ƒ   â”ƒ â”ƒ â”ƒ â”— ğŸ“œ...npy
 â”ƒ   â”ƒ â”— ğŸ“œ...pdf
 â”ƒ   â”£ ğŸ“œFQI.ipynb
 â”ƒ   â”£ ğŸ“œLSPI.ipynb
 â”ƒ   â”£ ğŸ“œPBO_custom_linear.ipynb
 â”ƒ   â”£ ğŸ“œPBO_linear.ipynb
 â”ƒ   â”£ ğŸ“œPBO_optimal.ipynb
 â”ƒ   â”£ ğŸ“œoptimal.ipynb
 â”ƒ   â”£ ğŸ“œparameters.json
 â”ƒ   â”£ ğŸ“œplots.ipynb
 â”ƒ   â”— ğŸ“œrun_seeds.sh
 â”£ ğŸ“‚test  # tests for the environments and the networks
 â”— ğŸ“‚pbo  # main code
```