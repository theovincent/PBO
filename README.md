# Projected Bellman Operator (PBO)

## User installation
### Without Docker, with Python 3.8 or 3.9 installed
In the folder where the code is, create a Python virtual environment, activate it and install the package and its dependencies in editable mode:
```bash
python3 -m venv env
source env/bin/activate
pip install -e .
```

### With Docker
Please see the [README](./docker/README.md) file made for that.

## Run the experiments
For an `environment` and an `algorithm`, a jupyter notebook running the associated the experience can be found at _experiments/[environment]/[algorithm].ipynb_.

For example, the jupyter notebook _experiments/chain_walk/PBO_linear.ipynb_ trains a linear PBO on the Chain-Walk environment.

To generate the plots with $N$ seeds with $K$ Bellman iterations, you first need to generate the data by running `./experiments/[environment]/run_seeds.sh -n_seeds N -n_bellman_iteration K`
and then run the jupyter notebook _experiments/[environment]/plots.ipynb_.

### Replicate figures
Figure 4a with one seed, run
```Bash
./experiments/chain_walk/run_seeds.sh --n_seeds 1 --n_bellman_iterations 5
jupyter nbconvert --to notebook --inplace --execute experiments/chain_walk/plots.ipynb
```
You will find Figure 4a at _experiments/chain_walk/figures/distance_to_optimal_V_5.pdf_. The code should take around 5 minutes to run.

Figure 4b with one seed, run
```Bash
./experiments/lqr/run_seeds.sh --n_seeds 1 --n_bellman_iterations 2
jupyter nbconvert --to notebook --inplace --execute experiments/lqr/plots.ipynb
```
You will find Figure 4b at _experiments/lqr/figures/distance_to_optimal_Pi_2.pdf_. The code should take around 2 minutes to run.

Figure 5a with one seed, run
```Bash
./experiments/car_on_hill/run_seeds.sh --n_seeds 1 --n_bellman_iterations 9
jupyter nbconvert --to notebook --inplace --execute experiments/car_on_hill/samples.ipynb
jupyter nbconvert --to notebook --inplace --execute experiments/car_on_hill/plots.ipynb
```
You will find Figure 5a at _experiments/car_on_hill/figures/distance_to_optimal_V_9.pdf_. The code should take around 30 minutes to run.

Figure 5b with one seed, run
```Bash
./experiments/bicycle/run_seeds_FQI.sh --n_seeds 1 --n_bellman_iterations 8
./experiments/bicycle/run_seeds_PBO_deep.sh --n_seeds 1 --n_bellman_iterations 8
./experiments/bicycle/run_seeds_PBO_linear.sh --n_seeds 1 --n_bellman_iterations 8
jupyter nbconvert --to notebook --inplace --execute experiments/bicycle/plots.ipynb
```
You will find Figure 5b at _experiments/bicycle/figures/seconds_8.pdf_. The code should take around 3 hours to run.

If any problem is encountered, make sure your files match the [file organization](#file-organization) and that the parameters _experiments/[environment]/plots.ipynb_ are matching the data that has been computed so far.

## Run Car On Hill
```Bash
car_on_hill_sample  # to collect the offline dataset 
car_on_hill_fqi -b 9 -s 1  # to train and evaluate FQI
car_on_hill_pbo -a linear -b 9 -s 1  # to train a linear PBO
car_on_hill_pbo_evaluate -a linear -b 9 -s 1  # to evaluate it
car_on_hill_pbo -a deep -b 9 -s 1  # to train a deep PBO
car_on_hill_pbo_evaluate -a deep -b 9 -s 1  # to evaluate it
```

## Run the tests
Run all tests with
```Bash
pytest
```
The code should take around 1 minutes to run.

## File organization
```
ðŸ“¦PBO
 â”£ ðŸ“‚env  # environment files
 â”£ ðŸ“‚experiments  # files to run the experiments
 â”ƒ â”£ ðŸ“‚bicycle
 â”ƒ â”ƒ â”£ ðŸ“‚figures
 â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚data
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚FQI
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy  # data generated by running the experiments
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚PBO_linear
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚PBO_linear_max_linear
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚PBO_optimal
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“‚optimal
 â”ƒ â”ƒ â”ƒ â”ƒ   â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...pdf  # plots of the experiments generated from plots.ipynb
 â”ƒ â”ƒ â”£ ðŸ“œFQI.ipynb
 â”ƒ â”ƒ â”£ ðŸ“œPBO_linear_max_linear.ipynb
 â”ƒ â”ƒ â”£ ðŸ“œPBO_linear.ipynb
 â”ƒ â”ƒ â”£ ðŸ“œparameters.json
 â”ƒ â”ƒ â”£ ðŸ“œplots.ipynb
 â”ƒ â”ƒ â”— ðŸ“œrun_seeds.sh
 â”ƒ â”£ ðŸ“‚car_on_hill
 â”ƒ â”ƒ â”£ ðŸ“‚figures
 â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚data
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚FQI
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚PBO_linear
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚PBO_linear_max_linear
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚PBO_optimal
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“‚optimal
 â”ƒ â”ƒ â”ƒ â”ƒ   â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...pdf
 â”ƒ â”ƒ â”£ ðŸ“œFQI.ipynb
 â”ƒ â”ƒ â”£ ðŸ“œPBO_linear_max_linear.ipynb
 â”ƒ â”ƒ â”£ ðŸ“œPBO_linear.ipynb
 â”ƒ â”ƒ â”£ ðŸ“œoptimal.py
 â”ƒ â”ƒ â”£ ðŸ“œparameters.json
 â”ƒ â”ƒ â”£ ðŸ“œplots.ipynb
 â”ƒ â”ƒ â”— ðŸ“œrun_seeds.sh
 â”ƒ â”£ ðŸ“‚chain_walk
 â”ƒ â”ƒ â”£ ðŸ“‚figures
 â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚data
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚FQI
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚LSPI
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚PBO_linear
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚PBO_max_linear
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”£ ðŸ“‚PBO_optimal
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“‚optimal
 â”ƒ â”ƒ â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...pdf
 â”ƒ â”ƒ â”£ ðŸ“œFQI.ipynb
 â”ƒ â”ƒ â”£ ðŸ“œLSPI.ipynb
 â”ƒ â”ƒ â”£ ðŸ“œPBO_linear.ipynb
 â”ƒ â”ƒ â”£ ðŸ“œPBO_max_linear.ipynb
 â”ƒ â”ƒ â”£ ðŸ“œPBO_optimal.ipynb
 â”ƒ â”ƒ â”£ ðŸ“œoptimal.ipynb
 â”ƒ â”ƒ â”£ ðŸ“œparameters.json
 â”ƒ â”ƒ â”£ ðŸ“œplots.ipynb
 â”ƒ â”ƒ â”— ðŸ“œrun_seeds.sh
 â”ƒ â”— ðŸ“‚lqr
 â”ƒ   â”£ ðŸ“‚figures
 â”ƒ   â”ƒ â”£ ðŸ“‚data
 â”ƒ   â”ƒ â”ƒ â”£ ðŸ“‚FQI
 â”ƒ   â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ   â”ƒ â”ƒ â”£ ðŸ“‚LSPI
 â”ƒ   â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ   â”ƒ â”ƒ â”£ ðŸ“‚PBO_custom_linear
 â”ƒ   â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ   â”ƒ â”ƒ â”£ ðŸ“‚PBO_linear
 â”ƒ   â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ   â”ƒ â”ƒ â”£ ðŸ“‚PBO_optimal
 â”ƒ   â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ   â”ƒ â”ƒ â”— ðŸ“‚optimal
 â”ƒ   â”ƒ â”ƒ â”ƒ â”— ðŸ“œ...npy
 â”ƒ   â”ƒ â”— ðŸ“œ...pdf
 â”ƒ   â”£ ðŸ“œFQI.ipynb
 â”ƒ   â”£ ðŸ“œLSPI.ipynb
 â”ƒ   â”£ ðŸ“œPBO_custom_linear.ipynb
 â”ƒ   â”£ ðŸ“œPBO_linear.ipynb
 â”ƒ   â”£ ðŸ“œPBO_optimal.ipynb
 â”ƒ   â”£ ðŸ“œoptimal.ipynb
 â”ƒ   â”£ ðŸ“œparameters.json
 â”ƒ   â”£ ðŸ“œplots.ipynb
 â”ƒ   â”— ðŸ“œrun_seeds.sh
 â”£ ðŸ“‚test  # tests for the environments and the networks
 â”— ðŸ“‚pbo  # main code
```

## Using a GPU
In the folder where the code is, create a Python virtual environment, activate it and install the package and its dependencies in editable mode:
```bash
python3 -m venv env_gpu
source env_gpu/bin/activate
pip install -e .
```

If jax does not recognize the gpu, you may need to run
```bash
pip install -U jax[cuda11_cudnn82]==0.3.22 -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html
```
Taken from https://github.com/google/jax/discussions/10323.


## Using a cluster
Download miniconda on the server host to get Python 3.8:
```Bash
wget https://repo.anaconda.com/miniconda/Miniconda3-py38_4.12.0-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh
```
Install cuda packages with:
```Bash
conda install -c conda-forge cudatoolkit-dev
```
do not forget to set the environment variable *LD_LIBRARY_PATH* correctly.
Finally, upgrade pip and install virtualenv
```Bash
python3 -m pip install --user --upgrade pip
python3 -m pip install --user virtualenv
```
Now you can go back to the [user installation](#user-installation) guidelines.